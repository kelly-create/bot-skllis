<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>任务 #{{ task.id }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --bg-page: #f4f6fb;
      --soft-border: #e9ecf3;
      --card-radius: 16px;
    }
    body { background: var(--bg-page); }
    .soft-card { border: 1px solid var(--soft-border); border-radius: var(--card-radius); box-shadow: 0 6px 22px rgba(16,24,40,.04); }
    .soft-card .card-header { background: #fff; border-bottom: 1px solid var(--soft-border); font-weight: 600; }
    .status-badge { font-size: .85rem; }
    .kv { color: #667085; font-size: .87rem; }
    .info-chip { border-radius: 999px; padding: .23rem .62rem; background: #eef2ff; color: #3730a3; font-size: .76rem; }
    .log-box {
      background: #0f172a;
      color: #e2e8f0;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      white-space: pre-wrap;
      max-height: 72vh;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid #1e293b;
      font-size: .85rem;
      line-height: 1.45;
    }
    .sticky-col { position: sticky; top: 1rem; }
    .table thead th { background: #fafbff; }
  </style>
</head>
<body>
<div class="container-fluid px-3 px-lg-4 py-3 py-lg-4">
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
    <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('dashboard') }}">← 返回任务面板</a>
    <div class="d-flex align-items-center gap-2">
      <span class="info-chip">任务 #{{ task.id }}</span>
      <button type="button" id="toggleRefreshBtn" class="btn btn-sm btn-outline-secondary" onclick="toggleAutoRefresh()">自动刷新：开</button>
    </div>
  </div>

  <div class="card soft-card mb-3">
    <div class="card-body d-flex justify-content-between align-items-start flex-wrap gap-2">
      <div>
        <h4 class="mb-1">{{ task.title }}</h4>
        <div class="kv d-flex flex-wrap gap-2">
          <span>执行者：<b>{{ task.assignee }}</b></span>
          <span>优先级：<b>{{ task.priority }}</b></span>
          <span>返回码：<b>{{ task.return_code if task.return_code is not none else '-' }}</b></span>
          <span>状态：
            {% if task.status == 'running' %}<span class="badge status-badge bg-warning text-dark">运行中</span>
            {% elif task.status == 'done' %}<span class="badge status-badge bg-success">完成</span>
            {% elif task.status == 'failed' %}<span class="badge status-badge bg-danger">失败</span>
            {% else %}<span class="badge status-badge bg-secondary">待办</span>{% endif %}
          </span>
        </div>
      </div>
      <div class="d-flex gap-1 flex-wrap">
        <form method="post" action="{{ url_for('start_task_route', task_id=task.id) }}"><button class="btn btn-sm btn-outline-primary">启动</button></form>
        <form method="post" action="{{ url_for('stop_task', task_id=task.id) }}"><button class="btn btn-sm btn-outline-danger">停止</button></form>
        <form method="post" action="{{ url_for('retry_task', task_id=task.id) }}"><button class="btn btn-sm btn-outline-secondary">重置</button></form>
        <form method="post" action="{{ url_for('delete_task', task_id=task.id) }}" onsubmit="return confirm('确认删除任务 #{{ task.id }} 吗？将同时删除日志和该任务附件/产物。');"><button class="btn btn-sm btn-danger">删除</button></form>
      </div>
    </div>
  </div>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="alert alert-info py-2 soft-card">{{ messages[0] }}</div>
    {% endif %}
  {% endwith %}

  <div class="row g-3">
    <div class="col-12 col-xxl-4">
      <div class="sticky-col">
        <div class="card soft-card mb-3">
          <div class="card-header bg-primary text-white">交付总览</div>
          <div class="card-body">
            <div class="mb-2"><b>{{ delivery.headline }}</b></div>
            <div class="progress mb-2" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="{{ delivery.progress }}">
              <div class="progress-bar" style="width: {{ delivery.progress }}%">{{ delivery.progress }}%</div>
            </div>
            <div class="small text-muted">下一步：{{ delivery.next_action }}</div>
            {% if delivery.latest_line %}
              <div class="small mt-2"><span class="text-muted">最新日志：</span><code>{{ delivery.latest_line }}</code></div>
            {% endif %}

            {% if delivery.failure %}
            <div class="alert alert-danger mt-2 mb-2 py-2">
              <div><b>失败原因：</b>{{ delivery.failure.reason }}</div>
              {% if delivery.failure.evidences and delivery.failure.evidences|length > 0 %}
              <div class="mt-1"><b>关键证据：</b></div>
              <ul class="mb-1 ps-3">
                {% for e in delivery.failure.evidences %}
                <li><small>{{ e }}</small></li>
                {% endfor %}
              </ul>
              {% endif %}
              <div><b>处理建议：</b>{{ delivery.failure.suggestion }}</div>
            </div>
            {% endif %}

            <div class="row g-2 mt-2 small">
              <div class="col-6"><div class="border rounded p-2 bg-light">交付包：<b>{{ delivery.groups.packs|length }}</b></div></div>
              <div class="col-6"><div class="border rounded p-2 bg-light">报告：<b>{{ delivery.groups.reports|length }}</b></div></div>
              <div class="col-6"><div class="border rounded p-2 bg-light">审计：<b>{{ delivery.groups.audits|length }}</b></div></div>
              <div class="col-6"><div class="border rounded p-2 bg-light">其他：<b>{{ delivery.groups.others|length }}</b></div></div>
            </div>

            {% if delivery.primary_pack %}
            <div class="d-grid mt-3">
              <a class="btn btn-success" href="{{ url_for('task_artifact_download', task_id=task.id, rel_path=delivery.primary_pack.rel_path) }}">一键下载交付包</a>
            </div>
            <div class="small text-muted mt-1">{{ delivery.primary_pack.name }}</div>
            {% endif %}
          </div>
        </div>

        {% if multiagent %}
        <details class="card soft-card mb-3">
          <summary class="card-header" style="cursor:pointer; list-style:none;">Lead 分发与复核轨迹（角色调用明细）</summary>
          <div class="card-body small">
            <div class="mb-1">工作流：<b>{{ multiagent.workflow }}</b></div>
            <div class="mb-1">本轮需求分析：<b>{{ multiagent.intake_role }}</b>（<code>{{ multiagent.intake_model }}</code>）</div>
            <div class="mb-1">步骤数：<b>{{ multiagent.steps }}</b> ｜ 返工：<b>{{ multiagent.rework_used }}/{{ multiagent.rework_max }}</b></div>
            <div class="mb-1">复核通过：<b>{{ multiagent.review_pass }}</b> ｜ 复核不通过：<b>{{ multiagent.review_fail }}</b></div>
            <div class="mb-2">阶段质控打回：<b>{{ multiagent.quality_fail }}</b></div>

            <div class="fw-semibold mb-1">本次实际调用角色</div>
            {% if multiagent.called_roles|length == 0 %}
              <div class="text-muted">暂无</div>
            {% else %}
              <div class="d-flex flex-wrap gap-1 mb-2">
                {% for r in multiagent.called_roles %}
                  <span class="badge text-bg-light border">{{ r }}</span>
                {% endfor %}
              </div>
            {% endif %}

            <div class="fw-semibold mb-1">动态分发结果</div>
            {% if multiagent.dispatch_items|length == 0 %}
              <div class="text-muted">本次未发生动态改写（沿用模板分配）</div>
            {% else %}
              <ul class="mb-2 ps-3">
                {% for d in multiagent.dispatch_items %}
                <li>{{ d.stage }} → {{ d.role }}</li>
                {% endfor %}
              </ul>
            {% endif %}

            <div class="fw-semibold mb-1">阶段执行轨迹</div>
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0">
                <thead><tr><th>步骤</th><th>阶段</th><th>角色</th><th>模型</th><th>耗时(s)</th><th>状态</th></tr></thead>
                <tbody>
                  {% for t in multiagent.stage_tracks %}
                  <tr>
                    <td>#{{ t.executionNo }}</td>
                    <td>{{ t.stage }}</td>
                    <td>{{ t.role }}</td>
                    <td><code>{{ t.model }}</code></td>
                    <td>{% if t.duration_sec is not none %}{{ t.duration_sec }}{% else %}-{% endif %}</td>
                    <td>
                      <div>{{ t.status }}</div>
                      {% if t.reason %}<div class="text-muted">{{ t.reason }}</div>{% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </details>
        {% endif %}

        {# 目录与环境变量卡片按用户要求隐藏 #}

        <div class="card soft-card">
          <div class="card-header">输入附件</div>
          <div class="card-body small">
            <form method="post" action="{{ url_for('task_upload', task_id=task.id) }}" enctype="multipart/form-data" class="mb-2">
              <div class="input-group input-group-sm">
                <input type="file" class="form-control" name="attachments" multiple required>
                <button class="btn btn-outline-primary">上传</button>
              </div>
            </form>

            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0">
                <thead><tr><th>文件</th><th>大小</th><th></th></tr></thead>
                <tbody>
                {% if input_files|length == 0 %}
                  <tr><td colspan="3" class="text-muted">暂无附件</td></tr>
                {% else %}
                  {% for f in input_files %}
                  <tr>
                    <td>
                      <div>{{ f.name }}</div>
                      <div class="text-muted">{{ f.mtime }}</div>
                    </td>
                    <td>{{ f.size_human }}</td>
                    <td><a class="btn btn-sm btn-outline-secondary" href="{{ url_for('task_artifact_download', task_id=task.id, rel_path=f.rel_path) }}">下载</a></td>
                  </tr>
                  {% endfor %}
                {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-xxl-8">
      <div class="card soft-card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>输出产物</span>
          <span class="small text-muted">将结果写入 <code>$TASK_OUTPUT_DIR</code></span>
        </div>
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle mb-0">
            <thead><tr><th>文件</th><th>大小</th><th>时间</th><th>下载</th></tr></thead>
            <tbody>
            {% if output_files|length == 0 %}
              <tr><td colspan="4" class="text-muted">暂无产物</td></tr>
            {% else %}
              {% for f in output_files %}
              <tr>
                <td>{{ f.name }}</td>
                <td>{{ f.size_human }}</td>
                <td>{{ f.mtime }}</td>
                <td><a class="btn btn-sm btn-primary" href="{{ url_for('task_artifact_download', task_id=task.id, rel_path=f.rel_path) }}">下载</a></td>
              </tr>
              {% endfor %}
            {% endif %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="card soft-card">
        <div class="card-header">执行日志（自动刷新）</div>
        <div class="card-body">
          <div id="logBox" class="log-box p-3">{% for l in logs %}[{{ l.ts }}] {{ l.line }}
{% endfor %}</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let autoRefreshEnabled = true;
let formDirty = false;

function setDirty() { formDirty = true; }

function toggleAutoRefresh() {
  autoRefreshEnabled = !autoRefreshEnabled;
  const btn = document.getElementById('toggleRefreshBtn');
  if (btn) btn.textContent = autoRefreshEnabled ? '自动刷新：开' : '自动刷新：关';
}

(function initGuard() {
  const fields = document.querySelectorAll('input, select, textarea');
  fields.forEach((el) => {
    el.addEventListener('input', setDirty);
    el.addEventListener('change', setDirty);
  });

  setInterval(() => {
    if (!autoRefreshEnabled) return;
    if (formDirty) return;
    const active = document.activeElement;
    if (active && active.closest && active.closest('form')) return;
    window.location.reload();
  }, 4500);
})();
</script>
</body>
</html>
