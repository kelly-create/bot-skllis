<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>任务 #{{ task.id }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --bg: #f3f4f6;
      --surface: #ffffff;
      --surface-soft: #f8fafc;
      --line: #e5e7eb;
      --text: #111827;
      --muted: #6b7280;
      --dark-1: #171717;
      --dark-2: #202020;
      --dark-3: #2f2f2f;
      --dark-text: #f5f5f5;
      --dark-muted: #a3a3a3;
    }
    body {
      background: linear-gradient(180deg, #f5f5f5 0%, #f3f4f6 55%, #f3f4f6 100%);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
    }
    .shell { max-width: 1520px; margin: 0 auto; }

    .topbar {
      border: 1px solid var(--dark-3);
      border-radius: 14px;
      background: var(--dark-1);
      color: var(--dark-text);
      padding: .6rem .8rem;
      box-shadow: 0 2px 10px rgba(0,0,0,.08);
    }
    .topbar .btn-outline-secondary {
      color: #e5e7eb;
      border-color: #4b5563;
      background: transparent;
    }
    .topbar .btn-outline-secondary:hover { color: #fff; border-color: #6b7280; background: #2c2c2c; }
    .topbar .btn-light { color: #111827; border-color: transparent; background: #f3f4f6; }
    .top-pill { border: 1px solid #3a3a3a; border-radius: 999px; padding: .16rem .55rem; font-size: .78rem; color: #d1d5db; background: #242424; }

    .panel {
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: 14px;
      box-shadow: 0 1px 2px rgba(16,24,40,.04);
      overflow: hidden;
    }
    .panel-head {
      padding: .78rem 1rem;
      border-bottom: 1px solid var(--line);
      font-weight: 600;
      background: #fcfcfd;
    }
    .panel-body { padding: .95rem 1rem; }

    .sidebar-sticky { position: sticky; top: .85rem; }
    .sidebar-shell {
      background: var(--dark-1);
      border: 1px solid var(--dark-3);
      border-radius: 16px;
      padding: .75rem;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.03);
    }
    .sidebar-shell .panel {
      background: var(--dark-2);
      border-color: #343434;
      color: var(--dark-text);
      box-shadow: none;
    }
    .sidebar-shell .panel-head {
      border-bottom-color: #343434;
      background: #232323;
      color: var(--dark-text);
    }
    .sidebar-shell .muted, .sidebar-shell .tiny,
    .sidebar-shell .form-label { color: var(--dark-muted) !important; }
    .sidebar-shell .btn-outline-secondary { color: #e5e7eb; border-color: #4b5563; }
    .sidebar-shell .btn-outline-secondary:hover { color: #fff; border-color: #6b7280; background:#2c2c2c; }

    .tiny { font-size: .82rem; }
    .muted { color: var(--muted); }
    .info-chip { border-radius: 999px; padding: .2rem .58rem; background: #eef2ff; color: #3730a3; font-size: .76rem; }
    .status-badge { font-size: .78rem; }

    .log-box {
      background: #0f172a;
      color: #e2e8f0;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      white-space: pre-wrap;
      max-height: 72vh;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid #1e293b;
      font-size: .84rem;
      line-height: 1.45;
    }
    .table thead th { background: #f9fafb; border-bottom-color: #e5e7eb; color: #4b5563; font-weight: 600; }
    .table-hover tbody tr:hover { background: #f8fafc; }
  </style>
</head>
<body>
<div class="container-fluid p-3 p-lg-4 shell">
  <div class="topbar d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <a class="btn btn-sm btn-light" href="{{ url_for('dashboard') }}">← 返回任务面板</a>
      <span class="top-pill">任务 #{{ task.id }}</span>
      <span class="top-pill">{{ task.workflow_code or '-' }}</span>
      <span class="top-pill">{{ task.assignee }}</span>
      <span class="top-pill">rc {{ task.return_code if task.return_code is not none else '-' }}</span>
      <span class="top-pill">
        {% if task.status == 'running' %}运行中
        {% elif task.status == 'done' %}完成
        {% elif task.status == 'failed' %}失败
        {% else %}待办{% endif %}
      </span>
    </div>
    <div class="d-flex gap-2 flex-wrap">
      <button type="button" id="toggleRefreshBtn" class="btn btn-sm btn-outline-secondary" onclick="toggleAutoRefresh()">自动刷新：开</button>
    </div>
  </div>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="alert alert-info py-2">{{ messages[0] }}</div>
    {% endif %}
  {% endwith %}

  <div class="row g-3">
    <div class="col-12 col-xl-4">
      <div class="sidebar-sticky sidebar-shell d-flex flex-column gap-3">
        <div class="panel">
          <div class="panel-head">任务摘要</div>
          <div class="panel-body">
            <div class="mb-2"><b>{{ task.title }}</b></div>
            <div class="tiny muted d-flex flex-column gap-1">
              <span>优先级：{{ task.priority }}</span>
              <span>状态：{{ task.status }}</span>
              <span>开始：{{ task.started_at|bjt if task.started_at else '-' }}</span>
              <span>更新：{{ task.updated_at|bjt }}</span>
            </div>
            <div class="d-flex gap-1 flex-wrap mt-3">
              <form method="post" action="{{ url_for('start_task_route', task_id=task.id) }}"><button class="btn btn-sm btn-outline-secondary">启动</button></form>
              <form method="post" action="{{ url_for('stop_task', task_id=task.id) }}"><button class="btn btn-sm btn-outline-secondary">停止</button></form>
              <form method="post" action="{{ url_for('retry_task', task_id=task.id) }}"><button class="btn btn-sm btn-outline-secondary">重置</button></form>
              <form method="post" action="{{ url_for('delete_task', task_id=task.id) }}" onsubmit="return confirm('确认删除任务 #{{ task.id }} 吗？将同时删除日志和该任务附件/产物。');"><button class="btn btn-sm btn-danger">删除</button></form>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-head">交付总览</div>
          <div class="panel-body">
            <div class="mb-2"><b>{{ delivery.headline }}</b></div>
            <div class="progress mb-2" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="{{ delivery.progress }}">
              <div class="progress-bar" style="width: {{ delivery.progress }}%">{{ delivery.progress }}%</div>
            </div>
            <div class="tiny muted">下一步：{{ delivery.next_action }}</div>
            {% if delivery.latest_line %}
              <div class="tiny mt-2"><span class="muted">最新日志：</span><code>{{ delivery.latest_line }}</code></div>
            {% endif %}

            {% if delivery.failure %}
            <div class="alert alert-danger mt-2 mb-2 py-2">
              <div><b>失败原因：</b>{{ delivery.failure.reason }}</div>
              {% if delivery.failure.evidences and delivery.failure.evidences|length > 0 %}
              <ul class="mb-1 ps-3 tiny">
                {% for e in delivery.failure.evidences %}<li>{{ e }}</li>{% endfor %}
              </ul>
              {% endif %}
              <div><b>处理建议：</b>{{ delivery.failure.suggestion }}</div>
            </div>
            {% endif %}

            <div class="row g-2 mt-2 tiny">
              <div class="col-6"><div class="border rounded p-2 bg-light">交付包：<b>{{ delivery.groups.packs|length }}</b></div></div>
              <div class="col-6"><div class="border rounded p-2 bg-light">报告：<b>{{ delivery.groups.reports|length }}</b></div></div>
              <div class="col-6"><div class="border rounded p-2 bg-light">审计：<b>{{ delivery.groups.audits|length }}</b></div></div>
              <div class="col-6"><div class="border rounded p-2 bg-light">其他：<b>{{ delivery.groups.others|length }}</b></div></div>
            </div>

            {% if delivery.primary_pack %}
            <div class="d-grid mt-3">
              <a class="btn btn-success" href="{{ url_for('task_artifact_download', task_id=task.id, rel_path=delivery.primary_pack.rel_path) }}">一键下载交付包</a>
            </div>
            {% endif %}
          </div>
        </div>

        {% if multiagent %}
        <details class="panel">
          <summary class="panel-head" style="cursor:pointer; list-style:none;">分发与复核轨迹（高级）</summary>
          <div class="panel-body small">
            <div class="mb-1">工作流：<b>{{ multiagent.workflow }}</b></div>
            <div class="mb-1">需求分析：<b>{{ multiagent.intake_role }}</b>（<code>{{ multiagent.intake_model }}</code>）</div>
            <div class="mb-1">步骤：<b>{{ multiagent.steps }}</b> ｜ 返工：<b>{{ multiagent.rework_used }}/{{ multiagent.rework_max }}</b></div>
            <div class="mb-2">质控打回：<b>{{ multiagent.quality_fail }}</b></div>

            <div class="fw-semibold mb-1">调用角色</div>
            <div class="d-flex flex-wrap gap-1 mb-2">
              {% for r in multiagent.called_roles %}<span class="badge text-bg-light border">{{ r }}</span>{% endfor %}
            </div>

            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0">
                <thead><tr><th>步骤</th><th>阶段</th><th>角色</th><th>模型</th><th>耗时</th></tr></thead>
                <tbody>
                  {% for t in multiagent.stage_tracks %}
                  <tr>
                    <td>#{{ t.executionNo }}</td>
                    <td>{{ t.stage }}</td>
                    <td>{{ t.role }}</td>
                    <td><code>{{ t.model }}</code></td>
                    <td>{% if t.duration_sec is not none %}{{ t.duration_sec }}s{% else %}-{% endif %}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </details>
        {% endif %}

        <details class="panel">
          <summary class="panel-head" style="cursor:pointer; list-style:none;">输入附件</summary>
          <div class="panel-body small">
            <form method="post" action="{{ url_for('task_upload', task_id=task.id) }}" enctype="multipart/form-data" class="mb-2">
              <div class="input-group input-group-sm">
                <input type="file" class="form-control" name="attachments" multiple required>
                <button class="btn btn-outline-secondary">上传</button>
              </div>
            </form>
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0">
                <thead><tr><th>文件</th><th>大小</th><th></th></tr></thead>
                <tbody>
                {% if input_files|length == 0 %}
                  <tr><td colspan="3" class="muted">暂无附件</td></tr>
                {% else %}
                  {% for f in input_files %}
                  <tr>
                    <td><div>{{ f.name }}</div><div class="muted tiny">{{ f.mtime }}</div></td>
                    <td>{{ f.size_human }}</td>
                    <td><a class="btn btn-sm btn-outline-secondary" href="{{ url_for('task_artifact_download', task_id=task.id, rel_path=f.rel_path) }}">下载</a></td>
                  </tr>
                  {% endfor %}
                {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </details>
      </div>
    </div>

    <div class="col-12 col-xl-8 d-flex flex-column gap-3">
      <div class="panel">
        <div class="panel-head d-flex justify-content-between align-items-center flex-wrap gap-2">
          <span>输出产物</span>
          <span class="tiny muted">结果目录：<code>$TASK_OUTPUT_DIR</code></span>
        </div>
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle mb-0">
            <thead><tr><th>文件</th><th>大小</th><th>时间</th><th>下载</th></tr></thead>
            <tbody>
            {% if output_files|length == 0 %}
              <tr><td colspan="4" class="muted">暂无产物</td></tr>
            {% else %}
              {% for f in output_files %}
              <tr>
                <td>{{ f.name }}</td>
                <td>{{ f.size_human }}</td>
                <td>{{ f.mtime }}</td>
                <td><a class="btn btn-sm btn-primary" href="{{ url_for('task_artifact_download', task_id=task.id, rel_path=f.rel_path) }}">下载</a></td>
              </tr>
              {% endfor %}
            {% endif %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="panel">
        <div class="panel-head d-flex justify-content-between align-items-center flex-wrap gap-2">
          <span>执行日志</span>
          <div class="d-flex gap-1 flex-wrap">
            <input id="logSearchInput" class="form-control form-control-sm" style="min-width:210px" placeholder="筛选日志关键词" />
            <select id="runFilter" class="form-select form-select-sm" style="min-width:180px">
              <option value="all">全部运行</option>
            </select>
            <button type="button" id="errorOnlyBtn" class="btn btn-sm btn-outline-secondary" onclick="toggleErrorOnly()">仅异常：关</button>
          </div>
        </div>
        <div class="panel-body">
          <div id="logBox" class="log-box p-3"></div>
          <textarea id="logRaw" class="d-none">{% for l in logs %}[{{ l.ts }}] {{ l.line }}
{% endfor %}</textarea>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let autoRefreshEnabled = true;
let formDirty = false;
let logErrorOnly = false;
let logSearch = '';
let logRunFilter = 'all';
let allLogLines = [];

function setDirty() { formDirty = true; }

function toggleAutoRefresh() {
  autoRefreshEnabled = !autoRefreshEnabled;
  const btn = document.getElementById('toggleRefreshBtn');
  if (btn) btn.textContent = autoRefreshEnabled ? '自动刷新：开' : '自动刷新：关';
}

function toggleErrorOnly() {
  logErrorOnly = !logErrorOnly;
  formDirty = true;
  const btn = document.getElementById('errorOnlyBtn');
  if (btn) btn.textContent = logErrorOnly ? '仅异常：开' : '仅异常：关';
  renderLogs();
}

function parseRunId(line) {
  const m = (line || '').match(/\[run:([^\]]+)\]/);
  return m ? m[1] : '';
}

function renderLogs() {
  const box = document.getElementById('logBox');
  if (!box) return;
  const out = allLogLines.filter((line) => {
    const l = (line || '').toLowerCase();
    if (logSearch && !l.includes(logSearch)) return false;
    if (logRunFilter !== 'all' && parseRunId(line) !== logRunFilter) return false;
    if (logErrorOnly) {
      const hit = ['error', '失败', '拒绝执行', 'fail', 'warn', '超时', 'timedout'].some(k => l.includes(k));
      if (!hit) return false;
    }
    return true;
  });
  box.textContent = out.join('\n');
  box.scrollTop = box.scrollHeight;
}

(function initGuard() {
  const fields = document.querySelectorAll('input, select, textarea');
  fields.forEach((el) => {
    if (el.id !== 'logSearchInput' && el.id !== 'runFilter') {
      el.addEventListener('input', setDirty);
      el.addEventListener('change', setDirty);
    }
  });

  const raw = document.getElementById('logRaw');
  allLogLines = ((raw?.value || '').split('\n')).filter(x => x.trim());

  const runSel = document.getElementById('runFilter');
  if (runSel) {
    const runIds = Array.from(new Set(allLogLines.map(parseRunId).filter(Boolean)));
    runIds.forEach((rid) => {
      const opt = document.createElement('option');
      opt.value = rid;
      opt.textContent = rid;
      runSel.appendChild(opt);
    });
    runSel.addEventListener('change', (e) => {
      logRunFilter = e.target.value || 'all';
      formDirty = true;
      renderLogs();
    });
  }

  const logSearchInput = document.getElementById('logSearchInput');
  if (logSearchInput) {
    logSearchInput.addEventListener('input', (e) => {
      logSearch = (e.target.value || '').trim().toLowerCase();
      formDirty = true;
      renderLogs();
    });
  }

  renderLogs();

  setInterval(() => {
    if (!autoRefreshEnabled) return;
    if (formDirty) return;
    const active = document.activeElement;
    if (active && active.closest && active.closest('form')) return;
    window.location.reload();
  }, 5000);
})();
</script>
</body>
</html>
