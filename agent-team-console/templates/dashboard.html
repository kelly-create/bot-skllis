<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agent Team æ§åˆ¶å°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --card-radius: 16px;
      --soft-border: #e9ecf3;
      --bg-page: #f4f6fb;
      --text-main: #1f2a44;
    }
    body { background: var(--bg-page); color: var(--text-main); }
    .navbar-brand { font-weight: 700; letter-spacing: .2px; }
    .top-pill { border: 1px solid rgba(255,255,255,.28); padding: .2rem .6rem; border-radius: 999px; }
    .soft-card { border: 1px solid var(--soft-border); border-radius: var(--card-radius); box-shadow: 0 6px 22px rgba(16,24,40,.04); }
    .soft-card .card-header { background: #fff; border-bottom: 1px solid var(--soft-border); font-weight: 600; }
    .metric-value { font-size: 1.7rem; font-weight: 700; line-height: 1.1; }
    .metric-label { color: #667085; font-size: .86rem; }
    .metric-icon { font-size: 1.15rem; }
    .phase-col { min-height: 420px; background: #fff; border-radius: 14px; border: 1px solid var(--soft-border); }
    .phase-head { border-bottom: 1px solid var(--soft-border); padding: .65rem .75rem; font-weight: 600; }
    .phase-body { padding: .65rem; max-height: 460px; overflow: auto; }
    .task-mini { border: 1px solid #e7eaf3; border-radius: 12px; background: #fbfcff; padding: .6rem; margin-bottom: .55rem; }
    .task-mini .title {
      font-size: .93rem;
      font-weight: 600;
      line-height: 1.35;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .muted-mini { color: #667085; font-size: .77rem; }
    .meta-chip { border: 1px solid #e3e8f3; background: #fff; color: #475467; border-radius: 999px; padding: .12rem .5rem; font-size: .72rem; }
    .task-title-link { color: #1f2a44; text-decoration: none; }
    .task-title-link:hover { color: #0f172a; text-decoration: none; }
    .summary-chip { background: #eef2ff; color: #3730a3; border-radius: 999px; padding: .2rem .55rem; font-size: .75rem; }
    .sticky-block { position: sticky; top: 1rem; }
    .table thead th { background: #fafbff; }
    .view-toolbar { border: 1px dashed #d8deea; border-radius: 12px; padding: .75rem; background: #fff; }
    .task-mini.hidden-by-filter, tr.hidden-by-filter { display: none !important; }
    .filter-chip { border: 1px solid #d6ddf0; background:#fff; color:#344054; border-radius:999px; padding:.2rem .6rem; font-size:.78rem; cursor:pointer; }
    .filter-chip.active { background:#1d4ed8; color:#fff; border-color:#1d4ed8; }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid px-3">
    <span class="navbar-brand">Agent Team æ§åˆ¶å°</span>
    <div class="d-flex align-items-center gap-2 text-white small flex-wrap">
      <span class="top-pill">å¹¶å‘ä¸Šé™ {{ g.max_concurrent }}</span>
      <span class="top-pill">æ´»è·ƒ {{ g.active_workers }}</span>
      <span class="top-pill">æ’é˜Ÿ {{ queue_count }}</span>
      <button type="button" id="toggleRefreshBtn" class="btn btn-sm btn-outline-light py-0 px-2" onclick="toggleAutoRefresh()">è‡ªåŠ¨åˆ·æ–°ï¼šå¼€</button>
      <a class="btn btn-sm btn-outline-light" href="{{ url_for('artifacts_page') }}">å…¨å±€äº§ç‰©</a>
      <a class="btn btn-sm btn-light" href="{{ url_for('logout') }}">é€€å‡º</a>
    </div>
  </div>
</nav>

<div class="container-fluid px-3 px-lg-4 py-3 py-lg-4">
  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="alert alert-info soft-card py-2">{{ messages[0] }}</div>
    {% endif %}
  {% endwith %}

  <div class="row g-3 mb-3">
    <div class="col-6 col-xl-3">
      <div class="card soft-card h-100"><div class="card-body d-flex justify-content-between align-items-center">
        <div><div class="metric-label">å¾…åŠ</div><div class="metric-value">{{ stats.pending }}</div></div><div class="metric-icon">ğŸ“</div>
      </div></div>
    </div>
    <div class="col-6 col-xl-3">
      <div class="card soft-card h-100"><div class="card-body d-flex justify-content-between align-items-center">
        <div><div class="metric-label">æ‰§è¡Œä¸­</div><div class="metric-value">{{ stats.running }}</div></div><div class="metric-icon">âš™ï¸</div>
      </div></div>
    </div>
    <div class="col-6 col-xl-3">
      <div class="card soft-card h-100"><div class="card-body d-flex justify-content-between align-items-center">
        <div><div class="metric-label">å·²å®Œæˆ</div><div class="metric-value">{{ stats.done }}</div></div><div class="metric-icon">âœ…</div>
      </div></div>
    </div>
    <div class="col-6 col-xl-3">
      <div class="card soft-card h-100"><div class="card-body d-flex justify-content-between align-items-center">
        <div><div class="metric-label">éœ€è¿”å·¥</div><div class="metric-value">{{ stats.failed }}</div></div><div class="metric-icon">ğŸš§</div>
      </div></div>
    </div>
  </div>

  <div class="view-toolbar mb-3">
    <div class="row g-2 align-items-center">
      <div class="col-md-6">
        <input id="taskSearchInput" class="form-control form-control-sm" placeholder="å¿«é€Ÿç­›é€‰ä»»åŠ¡ï¼šæ ‡é¢˜ / è§’è‰² / æ¨¡æ¿" />
      </div>
      <div class="col-md-6 d-flex gap-1 flex-wrap justify-content-md-end">
        <button type="button" class="filter-chip active" data-status-filter="all" onclick="setStatusFilter('all', this)">å…¨éƒ¨</button>
        <button type="button" class="filter-chip" data-status-filter="pending" onclick="setStatusFilter('pending', this)">å¾…å¤„ç†</button>
        <button type="button" class="filter-chip" data-status-filter="running" onclick="setStatusFilter('running', this)">æ‰§è¡Œä¸­</button>
        <button type="button" class="filter-chip" data-status-filter="done" onclick="setStatusFilter('done', this)">å¾…ç¡®è®¤</button>
        <button type="button" class="filter-chip" data-status-filter="failed" onclick="setStatusFilter('failed', this)">è¿”å·¥</button>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-12 col-xxl-8">
      <div class="card soft-card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>æ–°å»ºä»»åŠ¡ï¼ˆæ™ºèƒ½åŒè§’è‰²ï¼‰</span>
          <span class="summary-chip">åç«¯å…ˆè¯„ä¼°ï¼Œå†æŒ‰éœ€è°ƒåº¦å‰ç«¯/åç«¯</span>
        </div>
        <div class="card-body">
          <form method="post" action="{{ url_for('create_task') }}" enctype="multipart/form-data">
            <div class="row g-2">
              <div class="col-md-4">
                <label class="form-label">ä»»åŠ¡æ¨¡æ¿</label>
                <select class="form-select" name="workflow_template" id="workflow_template" onchange="onWorkflowChange()">
                  {% for wf in workflows %}
                    {% if wf.enabled == 1 %}
                    <option value="{{ wf.code }}" data-default-assignee="{{ wf.default_assignee or '' }}" data-default-task-type="{{ wf.default_task_type or '' }}" {% if wf.code == 'intelligent_dual' %}selected{% endif %}>
                      {{ wf.name }}ï¼ˆ{{ wf.code }}ï¼‰
                    </option>
                    {% endif %}
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-8">
                <label class="form-label">ä»»åŠ¡æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰</label>
                <input class="form-control" name="title" placeholder="å¯ä¸å¡«ï¼Œç³»ç»Ÿä¼šä»ä»»åŠ¡æè¿°è‡ªåŠ¨æå–" />
              </div>
            </div>

            <div class="mt-2">
              <label class="form-label">ä»»åŠ¡æè¿°ï¼ˆå¿…å¡«ï¼‰</label>
              <textarea class="form-control" name="task_brief" rows="5" placeholder="ç›´æ¥ç”¨å£è¯­å†™ä½ çš„ç›®æ ‡ã€èƒŒæ™¯ã€çº¦æŸã€è¦æ±‚ã€‚" required></textarea>
            </div>

            <div class="row g-2 mt-1">
              <div class="col-md-8">
                <label class="form-label">æœŸæœ›äº¤ä»˜ï¼ˆå¯é€‰ï¼‰</label>
                <input class="form-control" name="delivery_expectation" placeholder="ä¾‹å¦‚ï¼šä¸€ä»½ç»“è®ºæ‘˜è¦ + å¯ä¸‹è½½zipåŒ… + å®¡è®¡è¯´æ˜" />
              </div>
              <div class="col-md-4">
                <label class="form-label">é™„ä»¶ä¸Šä¼ ï¼ˆå¯é€‰ï¼‰</label>
                <input type="file" class="form-control" name="attachments" multiple>
              </div>
            </div>

            <details class="mt-3 border rounded p-2 bg-light-subtle">
              <summary><b>é«˜çº§è®¾ç½®ï¼ˆå¯é€‰ï¼‰</b></summary>
              <div class="row g-2 mt-2">
                <div class="col-md-3">
                  <label class="form-label">ä»»åŠ¡ç±»å‹</label>
                  <select class="form-select" name="task_type" title="ä»»åŠ¡ç±»å‹">
                    <option value="general" selected>generalï¼ˆé€šç”¨ï¼‰</option>
                    <option value="backend">backendï¼ˆç ”å‘ï¼‰</option>
                    <option value="research">researchï¼ˆè°ƒç ”ï¼‰</option>
                    <option value="ops">opsï¼ˆè¿ç»´ï¼‰</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label">æ‰§è¡Œè§’è‰²</label>
                  <select class="form-select" name="assignee" title="æ‰§è¡Œè§’è‰²">
                    {% for r in roles %}
                      {% if r.enabled == 1 %}
                      <option value="{{ r.code }}" {% if r.code == '@backend' %}selected{% endif %}>{{ r.name }}ï¼ˆ{{ r.code }}ï¼‰</option>
                      {% endif %}
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label">ä¼˜å…ˆçº§</label>
                  <select class="form-select" name="priority"><option>P0</option><option>P1</option><option selected>P2</option><option>P3</option></select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">é¡¹ç›®è·¯å¾„</label>
                  <input id="project_dir" class="form-control" name="project_dir" value="{{ g.workdir }}" placeholder="ä¾‹å¦‚ /opt/agent-team-console" />
                </div>
              </div>

              <div class="mt-2">
                <label class="form-label">è¡¥å……è¯´æ˜</label>
                <input class="form-control" name="description" placeholder="è¡¥å……éªŒæ”¶æ ‡å‡†ã€ç¦ç”¨é¡¹ã€é£é™©ç‚¹ç­‰" />
              </div>

              <div class="mt-2">
                <label class="form-label">è‡ªå®šä¹‰å‘½ä»¤ï¼ˆå¯é€‰ï¼‰</label>
                <input id="command_input" class="form-control" name="command" placeholder="ç•™ç©º=è‡ªåŠ¨ç”¨æ¨¡æ¿å‘½ä»¤ï¼›å¦‚æ¨¡æ¿æ— å‘½ä»¤åˆ™æ¼”ç¤ºæµç¨‹" />
              </div>
            </details>

            <div class="form-text mt-2">å¦‚æ¨¡æ¿éœ€è¦ç™»å½•æ€ï¼ˆä¾‹å¦‚å°çº¢ä¹¦ï¼‰ï¼Œè¯·ä¸Šä¼  <code>xhs_cookies.json</code> åˆ°å½“å‰ä»»åŠ¡é™„ä»¶ã€‚</div>
            <button class="btn btn-primary mt-3">åˆ›å»ºä»»åŠ¡</button>
          </form>
        </div>
      </div>

      <div class="card soft-card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>ä¸šåŠ¡é˜¶æ®µçœ‹æ¿</span>
          <span class="small text-muted">å·²ç²¾ç®€ä¸º 3 ä¸ªé˜¶æ®µï¼ˆå¾…å¤„ç† / æ‰§è¡Œä¸­ / å¾…ç¡®è®¤ï¼‰</span>
        </div>
        <div class="card-body">
          <div class="row g-2">
            {% for phase in phase_order %}
            <div class="col-md-6 col-xl-4">
              <div class="phase-col">
                <div class="phase-head d-flex justify-content-between align-items-center">
                  <span>{{ phase }}</span>
                  <span class="badge text-bg-secondary">{{ tasks_by_phase.get(phase, [])|length }}</span>
                </div>
                <div class="phase-body">
                  {% if tasks_by_phase.get(phase, [])|length == 0 %}
                    <div class="text-muted small">æš‚æ— ä»»åŠ¡</div>
                  {% else %}
                    {% for t in tasks_by_phase.get(phase, []) %}
                    <div class="task-mini" data-task-card="1" data-status="{{ t.status }}" data-search="{{ (t.title ~ ' ' ~ t.assignee ~ ' ' ~ (t.workflow_code or ''))|lower }}">
                      <div class="title"><a class="task-title-link" href="{{ url_for('task_detail', task_id=t.id) }}">#{{ t.id }} {{ t.title }}</a></div>
                      <div class="d-flex flex-wrap gap-1 mt-1">
                        <span class="meta-chip">{{ t.assignee }}</span>
                        <span class="meta-chip">{{ t.priority }}</span>
                        {% if t.status == 'failed' %}<span class="badge bg-danger">è¿”å·¥</span>{% endif %}
                      </div>
                      <div class="muted-mini mt-1">æ›´æ–°æ—¶é—´ï¼š{{ t.updated_at|bjt }}</div>
                      <div class="d-flex gap-1 flex-wrap mt-2">
                        {% if t.status == 'running' %}
                          <form method="post" action="{{ url_for('stop_task', task_id=t.id) }}"><button class="btn btn-sm btn-outline-danger">åœæ­¢</button></form>
                        {% elif t.status == 'done' %}
                          <form method="post" action="{{ url_for('retry_task', task_id=t.id) }}"><button class="btn btn-sm btn-outline-secondary">é‡ç½®</button></form>
                          <form method="post" action="{{ url_for('delete_task', task_id=t.id) }}" onsubmit="return confirm('ç¡®è®¤åˆ é™¤ä»»åŠ¡ #{{ t.id }} å—ï¼Ÿå°†åŒæ—¶åˆ é™¤æ—¥å¿—å’Œè¯¥ä»»åŠ¡é™„ä»¶/äº§ç‰©ã€‚');"><button class="btn btn-sm btn-danger">åˆ é™¤</button></form>
                        {% else %}
                          <form method="post" action="{{ url_for('start_task_route', task_id=t.id) }}"><button class="btn btn-sm btn-outline-primary">å¯åŠ¨</button></form>
                          <form method="post" action="{{ url_for('delete_task', task_id=t.id) }}" onsubmit="return confirm('ç¡®è®¤åˆ é™¤ä»»åŠ¡ #{{ t.id }} å—ï¼Ÿå°†åŒæ—¶åˆ é™¤æ—¥å¿—å’Œè¯¥ä»»åŠ¡é™„ä»¶/äº§ç‰©ã€‚');"><button class="btn btn-sm btn-danger">åˆ é™¤</button></form>
                        {% endif %}
                      </div>
                    </div>
                    {% endfor %}
                  {% endif %}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <details class="card soft-card mb-3">
        <summary class="card-header" style="cursor:pointer;">æŠ€æœ¯æ˜ç»†è¡¨ï¼ˆé«˜çº§ï¼‰</summary>
        <div class="card-body py-2 small text-muted">æŒ‰æŠ€æœ¯å­—æ®µæŸ¥çœ‹å…¨éƒ¨ä»»åŠ¡ï¼ˆé€‚åˆæ’éšœï¼‰ã€‚</div>
        <div class="table-responsive">
          <table class="table table-sm table-hover mb-0 align-middle">
            <thead><tr><th>æ ‡é¢˜</th><th>ç±»å‹</th><th>æ‰§è¡Œè€…</th><th>ä¼˜å…ˆçº§</th><th>çŠ¶æ€</th><th>è¿”å›ç </th><th>æ›´æ–°æ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
            <tbody>
            {% for t in tasks %}
              <tr data-task-row="1" data-status="{{ t.status }}" data-search="{{ (t.title ~ ' ' ~ t.assignee ~ ' ' ~ (t.workflow_code or '') ~ ' ' ~ (t.task_type or ''))|lower }}">
                <td><a class="task-title-link" href="{{ url_for('task_detail', task_id=t.id) }}">#{{ t.id }} {{ t.title }}</a></td>
                <td>{{ t.task_type }}</td>
                <td>{{ t.assignee }}</td>
                <td>{{ t.priority }}</td>
                <td>
                  {% if t.status == 'running' %}<span class="badge bg-warning text-dark">è¿è¡Œä¸­</span>
                  {% elif t.status == 'done' %}<span class="badge bg-success">å®Œæˆ</span>
                  {% elif t.status == 'failed' %}<span class="badge bg-danger">å¤±è´¥</span>
                  {% else %}<span class="badge bg-secondary">å¾…åŠ</span>{% endif %}
                </td>
                <td>{{ t.return_code if t.return_code is not none else '-' }}</td>
                <td>{{ t.updated_at|bjt }}</td>
                <td class="d-flex gap-1 flex-wrap">
                  <form method="post" action="{{ url_for('start_task_route', task_id=t.id) }}"><button class="btn btn-sm btn-outline-primary">å¯åŠ¨</button></form>
                  <form method="post" action="{{ url_for('stop_task', task_id=t.id) }}"><button class="btn btn-sm btn-outline-danger">åœæ­¢</button></form>
                  <form method="post" action="{{ url_for('retry_task', task_id=t.id) }}"><button class="btn btn-sm btn-outline-secondary">é‡ç½®</button></form>
                  <form method="post" action="{{ url_for('delete_task', task_id=t.id) }}" onsubmit="return confirm('ç¡®è®¤åˆ é™¤ä»»åŠ¡ #{{ t.id }} å—ï¼Ÿå°†åŒæ—¶åˆ é™¤æ—¥å¿—å’Œè¯¥ä»»åŠ¡é™„ä»¶/äº§ç‰©ã€‚');"><button class="btn btn-sm btn-danger">åˆ é™¤</button></form>
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      </details>
    </div>

    <div class="col-12 col-xxl-4">
      <div class="sticky-block">
        <div class="card soft-card mb-3">
          <div class="card-header">ç³»ç»Ÿè®¾ç½®</div>
          <div class="card-body">
            <form class="row g-2 align-items-end" method="post" action="{{ url_for('set_concurrency') }}">
              <div class="col-5">
                <label class="form-label">å¹¶å‘ä¸Šé™</label>
                <input type="number" class="form-control" min="1" max="16" name="max_concurrent" value="{{ g.max_concurrent }}" required>
              </div>
              <div class="col-7 d-grid">
                <button class="btn btn-primary">ä¿å­˜è®¾ç½®</button>
              </div>
            </form>
            <div class="small text-muted mt-2">å»ºè®® 2-6ï¼›å½“å‰æœºå™¨å…ˆç”¨ 4 æ›´ç¨³ã€‚</div>
          </div>
        </div>

        <details class="card soft-card mb-3">
          <summary class="card-header d-flex justify-content-between align-items-center" style="cursor:pointer; list-style:none;">
            <span>å…¨å±€è§’è‰²ä¸­å¿ƒï¼ˆé«˜çº§ï¼‰</span>
            <span class="small text-muted">é»˜è®¤æ”¶èµ·ï¼Œé¿å…ä¸»ç•Œé¢è‡ƒè‚¿</span>
          </summary>
          <div class="card-body small">
            <div class="table-responsive mb-2">
              <table class="table table-sm align-middle">
                <thead><tr><th>è§’è‰²</th><th>æ¨¡å‹</th><th>API</th><th>çŠ¶æ€</th><th></th></tr></thead>
                <tbody>
                  {% for r in roles %}
                  <tr>
                    <td>
                      <div class="fw-semibold">{{ r.name }}</div>
                      <div class="text-muted">{{ r.code }}</div>
                    </td>
                    <td><code>{{ r.default_model or '-' }}</code></td>
                    <td>
                      {% if r.api_ready %}
                        <span class="badge bg-success">å·²é…ç½®</span>
                        <div class="text-muted">{{ r.api_key_masked }}</div>
                      {% else %}
                        <span class="badge bg-warning text-dark">æœªé…ç½®</span>
                      {% endif %}
                    </td>
                    <td>{% if r.enabled == 1 %}<span class="badge bg-success">å¯ç”¨</span>{% else %}<span class="badge bg-secondary">åœç”¨</span>{% endif %}</td>
                    <td>
                      <form method="post" action="{{ url_for('toggle_role', role_id=r.id) }}" class="mb-1">
                        <button class="btn btn-sm btn-outline-secondary">{% if r.enabled == 1 %}åœç”¨{% else %}å¯ç”¨{% endif %}</button>
                      </form>
                    </td>
                  </tr>
                  <tr>
                    <td colspan="5" class="bg-light-subtle">
                      <details>
                        <summary>é…ç½® {{ r.code }}ï¼ˆæ¨¡å‹/API/æç¤ºè¯ï¼‰</summary>
                        <form class="row g-2 mt-1" method="post" action="{{ url_for('update_role_config', role_id=r.id) }}">
                          <div class="col-md-4"><input class="form-control form-control-sm" name="default_model" value="{{ r.default_model or '' }}" placeholder="æ¨¡å‹ï¼Œä¾‹å¦‚ gpt-5.3-codex"></div>
                          <div class="col-md-8"><input class="form-control form-control-sm" name="api_base" value="{{ r.api_base or '' }}" placeholder="API Baseï¼Œä¾‹å¦‚ https://api.openai.com"></div>
                          <div class="col-md-6"><input class="form-control form-control-sm" name="api_key" placeholder="API Keyï¼ˆç•™ç©º=ä¸ä¿®æ”¹ï¼‰"></div>
                          <div class="col-md-3"><input class="form-control form-control-sm" name="temperature" value="{{ r.temperature if r.temperature is not none else 0.3 }}" placeholder="temperature"></div>
                          <div class="col-md-3"><input class="form-control form-control-sm" name="max_tokens" value="{{ r.max_tokens if r.max_tokens is not none else 1200 }}" placeholder="max_tokens"></div>
                          <div class="col-12"><input class="form-control form-control-sm" name="system_prompt" value="{{ r.system_prompt or '' }}" placeholder="è§’è‰²ç³»ç»Ÿæç¤ºè¯ï¼ˆå¯é€‰ï¼‰"></div>
                          <div class="col-12"><button class="btn btn-sm btn-primary">ä¿å­˜é…ç½®</button></div>
                        </form>
                      </details>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <details>
              <summary>æ–°å¢è§’è‰²</summary>
              <form class="row g-2 mt-1" method="post" action="{{ url_for('create_role') }}">
                <div class="col-6"><input class="form-control form-control-sm" name="code" placeholder="codeï¼Œä¾‹å¦‚ @developer" required></div>
                <div class="col-6"><input class="form-control form-control-sm" name="name" placeholder="åç§°ï¼Œä¾‹å¦‚ å¼€å‘ Agent" required></div>
                <div class="col-12"><input class="form-control form-control-sm" name="default_model" value="gpt-5.3-codex" placeholder="é»˜è®¤æ¨¡å‹"></div>
                <div class="col-12"><input class="form-control form-control-sm" name="api_base" placeholder="API Baseï¼ˆå¯é€‰ï¼‰"></div>
                <div class="col-12"><input class="form-control form-control-sm" name="api_key" placeholder="API Keyï¼ˆå¯é€‰ï¼‰"></div>
                <div class="col-12"><input class="form-control form-control-sm" name="system_prompt" placeholder="ç³»ç»Ÿæç¤ºè¯ï¼ˆå¯é€‰ï¼‰"></div>
                <div class="col-12"><input class="form-control form-control-sm" name="description" placeholder="èŒè´£æè¿°ï¼ˆå¯é€‰ï¼‰"></div>
                <div class="col-12"><button class="btn btn-sm btn-primary">åˆ›å»ºè§’è‰²</button></div>
              </form>
            </details>
          </div>
        </details>

        <details class="card soft-card mb-3">
          <summary class="card-header" style="cursor:pointer; list-style:none;">å·¥ä½œæµæ¨¡æ¿ä¸­å¿ƒï¼ˆé«˜çº§ï¼‰</summary>
          <div class="card-body small">
            <div class="table-responsive mb-2">
              <table class="table table-sm align-middle">
                <thead><tr><th>æ¨¡æ¿</th><th>é˜¶æ®µ</th><th>é˜¶æ®µâ†’è§’è‰²</th><th>é»˜è®¤è§’è‰²</th><th></th></tr></thead>
                <tbody>
                  {% for wf in workflows %}
                  <tr>
                    <td>
                      <div class="fw-semibold">{{ wf.name }}</div>
                      <div class="text-muted">{{ wf.code }}</div>
                    </td>
                    <td>{{ ' â†’ '.join(wf.stages) if wf.stages else '-' }}</td>
                    <td>
                      {% if wf.stage_roles %}
                        {% for k,v in wf.stage_roles.items() %}
                          <div class="text-muted">{{ k }} â†’ {{ v }}</div>
                        {% endfor %}
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                    <td>{{ wf.default_assignee or '-' }}</td>
                    <td>
                      <form method="post" action="{{ url_for('toggle_workflow', workflow_id=wf.id) }}">
                        <button class="btn btn-sm btn-outline-secondary">{% if wf.enabled == 1 %}åœç”¨{% else %}å¯ç”¨{% endif %}</button>
                      </form>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <details>
              <summary>æ–°å¢å·¥ä½œæµæ¨¡æ¿</summary>
              <form class="row g-2 mt-1" method="post" action="{{ url_for('create_workflow') }}">
                <div class="col-12"><input class="form-control form-control-sm" name="code" placeholder="codeï¼Œä¾‹å¦‚ dev_test_verify" required></div>
                <div class="col-12"><input class="form-control form-control-sm" name="name" placeholder="æ¨¡æ¿åç§°" required></div>
                <div class="col-12"><input class="form-control form-control-sm" name="default_assignee" placeholder="é»˜è®¤è§’è‰²ï¼Œä¾‹å¦‚ @developer"></div>
                <div class="col-12"><input class="form-control form-control-sm" name="stages" placeholder="é˜¶æ®µï¼Œé€—å·åˆ†éš”ï¼Œå¦‚ å¼€å‘,æµ‹è¯•,éªŒè¯,äº¤ä»˜"></div>
                <div class="col-12"><input class="form-control form-control-sm" name="stage_roles" placeholder="é˜¶æ®µè§’è‰²æ˜ å°„ï¼Œå¦‚ å¼€å‘:@developer,æµ‹è¯•:@tester,éªŒè¯:@verifier"></div>
                <div class="col-12"><input class="form-control form-control-sm" name="description" placeholder="æ¨¡æ¿æè¿°ï¼ˆå¯é€‰ï¼‰"></div>
                <div class="col-12"><input class="form-control form-control-sm" name="command_template" placeholder="å‘½ä»¤æ¨¡æ¿ï¼ˆå¯é€‰ï¼Œæ”¯æŒ __PROJECT_DIR__ï¼‰"></div>
                <div class="col-8">
                  <select class="form-select form-select-sm" name="default_task_type">
                    <option value="general">generalï¼ˆé€šç”¨ï¼‰</option>
                    <option value="backend">backendï¼ˆç ”å‘ï¼‰</option>
                    <option value="research">researchï¼ˆè°ƒç ”ï¼‰</option>
                    <option value="ops">opsï¼ˆè¿ç»´ï¼‰</option>
                  </select>
                </div>
                <div class="col-4 d-grid"><button class="btn btn-sm btn-primary">åˆ›å»º</button></div>
              </form>
            </details>
          </div>
        </details>

        <details class="card soft-card">
          <summary class="card-header" style="cursor:pointer; list-style:none;">æ“ä½œæç¤º</summary>
          <div class="card-body small text-muted">
            <ul class="mb-0">
              <li><b>å¯åŠ¨</b>ï¼šåŠ å…¥æ‰§è¡Œé˜Ÿåˆ—ï¼›å¹¶å‘æ»¡ä¼šè‡ªåŠ¨æ’é˜Ÿã€‚</li>
              <li><b>åœæ­¢</b>ï¼šä¸­æ­¢ä»»åŠ¡å¹¶æ ‡è®°å¤±è´¥ã€‚</li>
              <li><b>é‡ç½®</b>ï¼šå°† done/failed æ¢å¤æˆ pendingã€‚</li>
              <li><b>ä»»åŠ¡è¯¦æƒ…</b>ï¼šæŸ¥çœ‹äº¤ä»˜æ€»è§ˆã€ä¸‹è½½äº§ç‰©ã€çœ‹å®æ—¶æ—¥å¿—ã€‚</li>
              <li><b>çœŸå¤šAgentæé†’</b>ï¼šè‹¥ä»»åŠ¡å‘½ä»¤ä¸ºç©ºï¼Œä¼šæŒ‰å·¥ä½œæµèµ°è§’è‰²ç‹¬ç«‹ä¼šè¯ï¼›éœ€å…ˆåœ¨â€œè§’è‰²ä¸­å¿ƒâ€é…ç½®æ¯ä¸ªè§’è‰²çš„ API/æ¨¡å‹ã€‚</li>
            </ul>
          </div>
        </details>
      </div>
    </div>
  </div>
</div>

<script>
let autoRefreshEnabled = true;
let formDirty = false;
let currentStatusFilter = 'all';
let currentSearchKeyword = '';

function setDirty() {
  formDirty = true;
}

function toggleAutoRefresh() {
  autoRefreshEnabled = !autoRefreshEnabled;
  const btn = document.getElementById('toggleRefreshBtn');
  if (btn) {
    btn.textContent = autoRefreshEnabled ? 'è‡ªåŠ¨åˆ·æ–°ï¼šå¼€' : 'è‡ªåŠ¨åˆ·æ–°ï¼šå…³';
  }
}

function setStatusFilter(status, btnEl) {
  currentStatusFilter = status || 'all';
  document.querySelectorAll('.filter-chip').forEach(chip => chip.classList.remove('active'));
  if (btnEl) btnEl.classList.add('active');
  applyTaskFilters();
}

function applyTaskFilters() {
  const cards = document.querySelectorAll('[data-task-card="1"]');
  const rows = document.querySelectorAll('[data-task-row="1"]');

  const match = (status, searchText) => {
    const okStatus = (currentStatusFilter === 'all') || (status === currentStatusFilter);
    const okSearch = !currentSearchKeyword || (searchText || '').includes(currentSearchKeyword);
    return okStatus && okSearch;
  };

  cards.forEach(el => {
    const ok = match(el.getAttribute('data-status') || '', (el.getAttribute('data-search') || '').toLowerCase());
    el.classList.toggle('hidden-by-filter', !ok);
  });
  rows.forEach(el => {
    const ok = match(el.getAttribute('data-status') || '', (el.getAttribute('data-search') || '').toLowerCase());
    el.classList.toggle('hidden-by-filter', !ok);
  });
}

function onWorkflowChange() {
  const wf = document.getElementById('workflow_template');
  const cmdInput = document.getElementById('command_input');
  const expectation = document.querySelector('input[name="delivery_expectation"]');
  const assignee = document.querySelector('select[name="assignee"]');
  const taskType = document.querySelector('select[name="task_type"]');
  if (!wf || !cmdInput) return;

  const opt = wf.options[wf.selectedIndex];
  const defAssignee = opt?.getAttribute('data-default-assignee') || '';
  const defTaskType = opt?.getAttribute('data-default-task-type') || '';

  if (defAssignee && assignee) {
    assignee.value = defAssignee;
  }
  if (defTaskType && taskType) {
    taskType.value = defTaskType;
  }

  if (wf.value === 'intelligent_dual') {
    cmdInput.placeholder = 'ç•™ç©º=ç”±åç«¯è§’è‰²å…ˆè¯„ä¼°ï¼Œå†æŒ‰éœ€è°ƒåº¦å‰ç«¯/åç«¯æ‰§è¡Œ';
    if (expectation && !expectation.value) {
      expectation.value = 'æœŸæœ›ï¼šæ˜ç¡®è¯„ä¼°ç»“è®ºã€å¿…è¦æ‰§è¡Œäº§ç‰©ã€æœ€ç»ˆäº¤ä»˜æ‘˜è¦';
    }
  } else if (wf.value === 'novel_multiagent') {
    cmdInput.placeholder = 'ç•™ç©ºå³å¯ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆå°è¯´å¤šAgentæµæ°´çº¿å‘½ä»¤';
    if (expectation && !expectation.value) {
      expectation.value = 'éœ€è¦å…³é”®è¯æŠ¥å‘Šã€çˆ†æ¬¾æ ‡é¢˜æ¨¡æ¿ã€å¼€å¤´æ¨¡æ¿ã€å‹ç¼©åŒ…äº¤ä»˜';
    }
  } else if (wf.value === 'xhs_virtual_keywords') {
    cmdInput.placeholder = 'ç•™ç©ºå³å¯ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆå°çº¢ä¹¦å…³é”®è¯åˆ†æå‘½ä»¤';
    if (expectation && !expectation.value) {
      expectation.value = 'éœ€è¦é«˜é¢‘è¯æŠ¥å‘Šï¼ˆmd/jsonï¼‰å’Œå¯ä¸‹è½½äº§ç‰©';
    }
  } else {
    cmdInput.placeholder = 'ç•™ç©º=æŒ‰æ¨¡æ¿è‡ªåŠ¨ç”Ÿæˆå‘½ä»¤ï¼›å¦‚æ¨¡æ¿æ— å‘½ä»¤åˆ™æ¼”ç¤ºæµç¨‹';
  }
  formDirty = true;
}

(function initAutoRefreshGuard() {
  const fields = document.querySelectorAll('input, select, textarea');
  fields.forEach((el) => {
    el.addEventListener('input', setDirty);
    el.addEventListener('change', setDirty);
  });

  const searchInput = document.getElementById('taskSearchInput');
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      currentSearchKeyword = (e.target.value || '').trim().toLowerCase();
      applyTaskFilters();
    });
  }

  onWorkflowChange();
  applyTaskFilters();

  setInterval(() => {
    if (!autoRefreshEnabled) return;
    if (formDirty) return;
    const active = document.activeElement;
    if (active && active.closest && active.closest('form')) return;
    window.location.reload();
  }, 7000);
})();
</script>
</body>
</html>
