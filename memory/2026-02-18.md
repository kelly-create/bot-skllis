# 2026-02-18 记忆存档

## 主题：X 自动任务漏执行深度排查 + 临时重构

### 现象
- 用户反馈：X 自动任务窗口到点后无 Telegram 通知。
- 观测到：
  - `jobs.json` 中 X 两个周期任务（20:00 UTC / 04:00 UTC）`enabled=true` 且 `nextRunAtMs` 正常滚动。
  - 但 `cron runs` 中无对应新执行记录（尤其 `ba979e82...` 长期为空）。

### 深度定位
1. 验证 cron 引擎是否完全失效：
   - `at` 一次性任务可自动执行（`AUTO_OK` 记录落盘到 `/root/.openclaw/cron/runs/*.jsonl`）。
2. 验证周期 cron：
   - 新建 `*/1 * * * *` 分钟任务，`nextRunAtMs` 每分钟前移，但不产生 runs 记录。
3. 代码级定位（openclaw dist）：
   - `onTimer()` 中顺序为：`ensureLoaded(forceReload=true)` -> `runDueJobs()`
   - `ensureLoaded()` 会先 `recomputeNextRuns()`，对 cron/every 直接按当前时间计算下一窗口。
   - 结果：到点窗口可能在 `runDueJobs()` 前被推进到未来，造成“看起来在跑，实际未执行”。

### 结论
- 周期 cron 在当前版本存在漏触发风险（窗口被重算跳过）。
- `at` 一次性任务链路正常。

### 已实施修复（临时可靠方案）
1. 关闭原 X 周期任务：
   - `0cdb154f-af7c-4fdb-ae90-bd962bb30341` -> `enabled=false`
   - `ba979e82-7009-40a2-b33f-a3befc3346fe` -> `enabled=false`
2. 预排程 7 天 AT 任务（共 14 条，均 `delivery=telegram:6221493343`）：
   - 中午档（20:00 UTC）：`X自动任务-中午AT-2026-02-18` ... `2026-02-24`
   - 晚上档（04:00 UTC）：`X自动任务-晚上AT-2026-02-19` ... `2026-02-25`
3. 执行链路统一：SSH 到萝卜运行 `python3 -u /root/x_daily.py`，并要求拿最终 rc 后再汇报。

### 验证
- 强制触发新 AT 任务 `6564b294...`，成功落 runs：
  - `rc:0`，`✅ retweet 完成 1 个操作`。
  - runs 文件：`/root/.openclaw/cron/runs/6564b294-9742-441f-8329-371e4a8b2abb.jsonl`

### 后续建议
- 正式修复 cron 周期调度顺序（`runDueJobs` 与 `recomputeNextRuns` 先后关系）后，再迁回周期 cron。
- 在迁回前，继续使用 AT 预排程并每日补充未来窗口（滚动 7 天）。

## 追加事件（2026-02-18 19:xx UTC）

- 用户反馈：X 账号已被冻结，判定当前“自动任务成功日志”不可信于真实业务目标。
- 立即处置：
  - 已将所有 X 相关任务（含 7 天 AT 预排程）全部 `enabled=false`，防止继续触发风险。
  - 保留任务记录，待账号恢复后再按更严格风控策略重建。
- 额外观测：
  - 账号访问 `https://x.com/account/access` 出现 Cloudflare security verification 页面（需人工通过）。
  - 当前脚本成功判定仅基于“点击成功”，未做强一致业务校验（如状态回读/结果二次验证），存在“假成功”空间。
- 后续改造方向：
  - 增加动作后回读校验（retweet->`unretweet` 状态、like->`unlike` 状态、post->个人页可见新帖）。
  - 一旦检测到 `restricted/suspended/verify` 立即失败并告警，且自动熔断后续任务。
