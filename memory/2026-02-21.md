# 2026-02-21

## 多Agent角色编排修正（Lead先接收并分发）

- 用户反馈：当前角色设置仍不对，要求由首个角色先接收需求，再按角色分发给后续角色。
- 已完成后端修正并上线：
  1. 默认工作流统一改为第一阶段 `需求接收与分发`，角色固定 `Lead Agent`。
  2. `dev_test_verify` 改为 5 阶段：`需求接收与分发 -> 开发 -> 测试 -> 验证 -> 交付`。
  3. 其他内置工作流也统一前置 `需求接收与分发` 阶段。
  4. `stage_roles_json` 对内置模板改为强制更新，确保现网模板立即生效（不再仅空值回填）。
  5. Lead 在分发阶段有专用提示词：输出“分发清单（角色/目标/输入/输出/验收）”，只做拆解分发不代替执行角色。

- 验证：
  - 新任务 `#18`（dev_test_verify）日志已显示：
    - `阶段1/5：需求接收与分发 -> Lead Agent`
    - 随后才进入 `阶段2/5：开发 -> @developer`
  - 说明“先接收再分发”的执行顺序已生效。

## 动态分发 + 阶段质控打回（按用户新增要求）

- 用户新增要求：
  - Lead 需要动态分发任务；
  - 每个角色完成后都要有复核把控与打回措施；
  - 防止无限循环。
- 已完成后端增强：
  1. Lead 分发阶段支持动态角色改写：
     - 要求 Lead 输出 `assignments` JSON；
     - 系统解析后可覆盖后续阶段角色（仅允许已启用角色、已存在阶段）。
  2. 每阶段质控（非Lead分发、非复核阶段）：
     - 每个阶段结束后由 `@verifier` 做“阶段质控”；
     - FAIL 自动打回当前阶段重做，携带问题与修改要求。
  3. 防无限循环：
     - 全局返工轮次：`ATC_MAX_REWORK_ROUNDS`（默认2）
     - 阶段重试上限：`ATC_STAGE_REVIEW_MAX_RETRIES`（默认2）
     - 迭代总上限保护。
  4. 审计增强：
     - 记录 `dynamicAssignments`、阶段质控结论、各步骤重试轮次。

## 交付页可视化补齐（同日）

- 用户同意后，已把“Lead动态分发与复核轨迹”做成任务详情页卡片。
- 显示内容：
  - 工作流名称、步骤数、返工使用次数
  - 复核通过/不通过统计
  - 阶段质控打回次数
  - 动态分发结果（阶段 → 角色）
- 验证：任务 `#17` 详情页可见 `Lead 分发与复核轨迹` 卡片。
