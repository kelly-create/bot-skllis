# 2026-02-21

## 多Agent角色编排修正（Lead先接收并分发）

- 用户反馈：当前角色设置仍不对，要求由首个角色先接收需求，再按角色分发给后续角色。
- 已完成后端修正并上线：
  1. 默认工作流统一改为第一阶段 `需求接收与分发`，角色固定 `Lead Agent`。
  2. `dev_test_verify` 改为 5 阶段：`需求接收与分发 -> 开发 -> 测试 -> 验证 -> 交付`。
  3. 其他内置工作流也统一前置 `需求接收与分发` 阶段。
  4. `stage_roles_json` 对内置模板改为强制更新，确保现网模板立即生效（不再仅空值回填）。
  5. Lead 在分发阶段有专用提示词：输出“分发清单（角色/目标/输入/输出/验收）”，只做拆解分发不代替执行角色。

- 验证：
  - 新任务 `#18`（dev_test_verify）日志已显示：
    - `阶段1/5：需求接收与分发 -> Lead Agent`
    - 随后才进入 `阶段2/5：开发 -> @developer`
  - 说明“先接收再分发”的执行顺序已生效。

## 动态分发 + 阶段质控打回（按用户新增要求）

- 用户新增要求：
  - Lead 需要动态分发任务；
  - 每个角色完成后都要有复核把控与打回措施；
  - 防止无限循环。
- 已完成后端增强：
  1. Lead 分发阶段支持动态角色改写：
     - 要求 Lead 输出 `assignments` JSON；
     - 系统解析后可覆盖后续阶段角色（仅允许已启用角色、已存在阶段）。
  2. 每阶段质控（非Lead分发、非复核阶段）：
     - 每个阶段结束后由 `@verifier` 做“阶段质控”；
     - FAIL 自动打回当前阶段重做，携带问题与修改要求。
  3. 防无限循环：
     - 全局返工轮次：`ATC_MAX_REWORK_ROUNDS`（默认2）
     - 阶段重试上限：`ATC_STAGE_REVIEW_MAX_RETRIES`（默认2）
     - 迭代总上限保护。
  4. 审计增强：
     - 记录 `dynamicAssignments`、阶段质控结论、各步骤重试轮次。

## 交付页可视化补齐（同日）

- 用户同意后，已把“Lead动态分发与复核轨迹”做成任务详情页卡片。
- 显示内容：
  - 工作流名称、步骤数、返工使用次数
  - 复核通过/不通过统计
  - 阶段质控打回次数
  - 动态分发结果（阶段 → 角色）
- 验证：任务 `#17` 详情页可见 `Lead 分发与复核轨迹` 卡片。

## 轨迹可读性再优化（同日）

- 用户反馈：分发/复核轨迹“看不出具体调用了哪些角色，容易误解”。
- 已优化任务详情页卡片：
  1. 卡片标题升级为“角色调用明细”。
  2. 新增“本次实际调用角色”列表（按首次出现顺序）。
  3. 新增“阶段执行轨迹”表格：
     - 步骤号
     - 阶段
     - 角色
     - 模型
     - 状态（含复核/质控 PASS/FAIL 原因摘要）
  4. 动态分发结果仍保留，避免信息丢失。
- 验证：`/tasks/17` 页面已可见上述模块与表头。

## 详情页按用户新要求微调（同日）

- 用户新增要求：
  1) 增加“本轮需求分析由哪个角色、哪个模型处理”；
  2) 隐藏“目录与环境变量”页签；
  3) 每步骤增加耗时（秒）。
- 已完成：
  - `load_multiagent_summary` 新增 `intake_role/intake_model` 识别逻辑。
  - 阶段审计新增 `durationSec`（每步骤调用耗时，单位秒）。
  - 轨迹表新增“耗时(s)”列。
  - 任务详情页新增“本轮需求分析：角色（模型）”行。
  - “目录与环境变量”卡片已隐藏。
- 验证：`/tasks/17` 页面已显示“本轮需求分析”和“耗时(s)”列，且无“目录与环境变量”卡片。

## 失败诊断可视化（同日）

- 用户反馈：任务失败后看不到具体原因，不知道如何修复。
- 已优化任务详情页“交付总览”：
  - 新增失败诊断区块（仅失败任务显示）：
    - 失败原因（主因）
    - 关键证据（最近失败相关日志）
    - 处理建议（按错误类型给修复方向）
  - 典型错误会给针对性建议：
    - API/模型配置缺失
    - 阶段质控未通过
    - 超过重试上限
    - 模型HTTP调用失败
- 验证：`/tasks/21` 已显示“阶段执行质控未通过且达最大重试”的明确原因和处理建议。

## 角色工具执行桥（同日）

- 针对“角色只会说，不会真正执行爬虫/脚本”的问题，已新增工具执行桥：
  1. 普通执行阶段支持角色输出结构化动作：
     - `{"action":"run_command","command":"...","reason":"..."}`
     - 系统真实执行命令并回传结果给同一角色继续处理
     - 完成时输出 `{"action":"final","content":"..."}`
  2. 增加命令安全检查（高危命令拦截）与超时控制。
  3. 命令执行结果会注入角色会话，并写入任务日志（round/rc/timedOut/cmd）。
  4. 对“爬取/关键词/文包”等任务增加产物硬校验：执行阶段未产出真实文件会自动质控 FAIL。
- 已上线并完成联调：
  - 任务 `#22` 跑通 `custom_brief`（rc=0）。

## 任务 #21 修复（同日）

- 问题根因：
  - `#21` 原先走 `custom_brief`，执行阶段由模型自由发挥；虽然会“计划调用爬虫”，但没有稳定产出真实文件。
  - 新增的产物硬校验生效后，执行阶段连续被判定“无可验收文件”，最终触发重试上限失败。
- 修复措施：
  1. 新增自动路由：当 `custom_brief` 且任务文本高置信度命中“小说+关键词/文包/爬取/采集”时，自动路由到 `novel_multiagent` 专用流水线。
  2. 对 `#21` 立即修复路由并改为专用命令链路重跑。
- 修复结果：
  - `#21` 最终 `done, rc=0`。
  - 产物包含：
    - `小说类目_高频词_纯化版.md/json`
    - `小说类目_爆款文包_纯化版.md/json`
    - `小说类目_爆款文包_纯化版.zip`
    - `小说类目_多Agent复核_审计.json`

## Lead 分发机制修正（同日）

- 用户反馈“需求接收应先评估，再分配需要执行的角色”后，已进一步改造：
  1. Lead 分发提示词新增“先评估复杂度与风险，再分发”。
  2. 分发 JSON 协议升级为：`assignments + active_stages + skip_stages`。
  3. 执行引擎支持“动态阶段激活”：Lead 可明确哪些阶段本轮执行、哪些跳过。
  4. 被跳过阶段会记录日志与审计（`SKIPPED`），避免“看起来跑了但其实不该跑”的歧义。
  5. 保底安全：验证/复核/交付类阶段默认保留，避免误跳过质控。

## 任务 #24 数据源偏少修复（同日）

- 用户指出“任务24数据源太少，至少需要最近7天的数据”。
- 复盘发现两处根因：
  1. 旧命令关键词较少（7个），`sourceCount` 实际受关键词数量强约束；
  2. `xhs_novel_multiagent_pipeline.py` 旧逻辑存在“strict失败仍可继续打包并返回rc=0”的漏洞（所有轮次 rc=2 仍可能产出文包）。
- 修复内容：
  1. `xhs_virtual_keywords.py` 新增 `recent7dSourceCount` 统计与 `--min-recent-7d` 严格阈值；
  2. `xhs_novel_multiagent_pipeline.py` 增加 `--min-recent-7d`（默认7）与“未过质量闸门即失败”；仅在显式 `--allow-best-effort` 时允许降级；
  3. `app.py` 的 `novel_multiagent` 默认命令追加 `--min-recent-7d 7`；
  4. 任务24采样关键词扩展到13个。
- 验证结果（13:54~14:00 UTC）：
  - 审计显示第1轮通过：`usable=13`、`recent7d=8~10`、`domainRatio=1.0`，`decision=pass`。

## 重跑可观测性与隔离修复（同日）

- 用户同意后已落地两项稳定性修复：
  1. 每次任务启动都会生成 `run_id`，并自动给该次运行日志打前缀：`[run:...]`；
  2. 每次重跑会自动清理 `output/` 旧文件，并清空该任务的 `role_session_messages`，避免旧轮次上下文污染。
- 同时增强手动停止：
  - 子进程改为独立进程组启动（`start_new_session=True`）；
  - 停止时优先 `killpg` 整个进程组，避免“父进程停了、子爬虫残留”导致的假运行与日志混杂。

## 控制台任务清理（同日）

- 按用户要求清理“当前所有测试任务”。
- 已执行：
  - 停止 `agent-team-console` 服务；
  - 清空 `tasks` / `task_logs` / `role_session_messages`；
  - 重置 SQLite 自增序列；
  - 删除全部 `artifacts/task_*` 目录；
  - 重启服务并验证 `active`。
- 清理前后：
  - tasks: `23 -> 0`
  - task_logs: `815 -> 0`
  - role_session_messages: `123 -> 0`
  - task_dirs: `23 -> 0`

## 任务1反爬拦截复盘与修复（同日）

- 用户指出：第一次被拦截后，第二次应该“思考并切换绕拦截策略”，而不是机械重跑。
- 复盘结论：
  - 原链路仅做重试与固定参数轮次，缺少“识别频控 -> 策略切换”的闭环。
  - 任务1中大量页面实际为 `请求太频繁` / `Scan with logged-in`，导致有效采样源长期不足。
- 已改造：
  1. `xhs_virtual_keywords.py` 新增频控信号识别（中英双语）与 `throttleSourceCount` 统计；
  2. 支持关键词级反拦截参数：`kw_delay_min/max`、`retry_on_throttle`、`cooldown_on_throttle`；
  3. 命中频控后自动冷却并重试当前关键词，不再直接按正常页继续；
  4. `xhs_novel_multiagent_pipeline.py` 新增“反拦截自适应”：上一轮频控比例高或有效样本过低时，下一轮自动切换为慢速+禁扩词+更长冷却策略。
- 现状：已将新策略部署到生产脚本，并对任务1发起新一轮验证运行。

## Agent Team 架构重构（同日）

- 用户授权“后续所有操作”，并要求重构为真正智能的双角色体系（仅前端/后端两主角色）。
- 已完成核心重构：
  1. 新增 `@frontend` 与 `@backend` 两个主角色，并接入现网 API；
  2. 新增工作流 `intelligent_dual`（需求评估与分配→前端实现→后端实现→联合交付）；
  3. 分发机制从“仅 Lead Agent”放开到“首阶段评估角色可动态分配”，支持 `active_stages/skip_stages`；
  4. 工具桥默认轮次提升为 6（可配），增强角色独立执行与自愈；
  5. 任务创建默认模板改为 `intelligent_dual`，取消对小说任务的强制自动路由；
  6. 已将旧刚性模板默认停用（保留回退用），主流程切换到双角色智能模式。
- 用户后续指定模型分工调整：
  - `@frontend` → `MiniMax-M2.5`
  - `@backend` → `gpt-5.3-codex`
- 前端页面优化（第二轮）：
  - Dashboard 新增“快速筛选工具条”（关键词+状态chip），支持实时过滤看板卡片和技术表；
  - Dashboard 将“角色中心/工作流中心/操作提示”改为默认折叠，减少信息噪声；
  - 新建任务区文案改为“双角色评估驱动”；
  - 任务详情新增日志筛选控件（关键词 / 运行ID / 仅异常）；
  - 任务详情中的“分发与复核轨迹”改为折叠展示，优先看交付与日志。
- 前端页面优化（第三轮，参考 chatgpt.com 的“轻主区+侧栏”布局）：
  - Dashboard 重排为“左侧轻量侧栏 + 右侧主工作区”；
  - 主区仅保留“新建任务 + 任务列表”两块核心内容；
  - 视觉上减少边框和多色块，统一极简卡片风格，降低认知负担。
- 前端页面优化（第四轮）：
  - 侧栏改为深色风格，更接近 chatgpt 的视觉层级；
  - “任务概览”改为可点击统计项（点击即按状态筛选并跳转到任务列表）；
  - 修复“任务概览无法点击”的交互缺失。
- 前端页面优化（第五轮，解决“整体不协调”）：
  - 统一全局配色Token（浅主区 + 深侧栏 + 统一边框与阴影）；
  - 顶栏改为深色并统一按钮状态，减少“亮暗混搭”的割裂感；
  - 表格、状态chip、标题链接、hover反馈统一风格，提升整体一致性。
- 任务详情页优化（第六轮）：
  - 详情页重排为与主页一致的“深色顶栏 + 深侧栏 + 浅色主工作区”；
  - 左侧改为“任务摘要 / 交付总览 / 轨迹(折叠) / 输入附件(折叠)”；
  - 右侧聚焦“输出产物 + 日志筛选”，减少信息拥挤与视觉割裂。

## 角色收敛（同日）

- 用户要求“去掉角色名前缀@，并只保留前端/后端/Lead，同时新增复核角色”。
- 当前角色与模型：
  - `Lead Agent` = `gpt-5.3-codex`
  - `frontend` = `MiniMax-M2.5`
  - `backend` = `gpt-5.3-codex`
  - `reviewer` = `gpt-5.3-codex`
- 已执行：
  1. 线上角色表清理并重命名，移除 `@` 前缀；
  2. 工作流中心历史清理，仅保留 `intelligent_dual`；
  3. `intelligent_dual` 改为 Lead 评估调度、前后端执行、reviewer复核、Lead联合交付；
  4. 复核失败会给出意见并打回；Lead 在最终验收阶段同样拥有打回权限；
  5. 每任务默认最大处理轮次相关参数改为 5：返工轮次/阶段重试/工具执行轮次。
  6. 修复“frontend 显示未配置”：已回填 MiniMax API base/key，并实测 chat/completions 返回 200。
- 额外修复：
  - 修复“联合交付阶段明明已有产物却被误判无产物”问题（质控改看当前可验收产物集合，不仅看本阶段新增文件）。
