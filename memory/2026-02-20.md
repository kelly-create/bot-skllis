# 2026-02-20

## Agent Team 控制台 V2（阶段1：口语化任务页）

- 用户反馈：当前任务创建仍偏“技术参数输入”（标题/高级模式/项目路径），不符合口语化布置任务。
- 已完成改造并上线 `https://agent.caopi.de`：
  1. 新建任务卡改为“新建任务（口语化）”。
  2. 主输入改为大段 `任务描述`（必填）+ `期望交付` + `附件上传`。
  3. 新增 `任务模板`（通用口语任务 / 小说多Agent / 小红书高频词）。
  4. 将命令、项目路径、角色等下沉到 `<details>` 高级设置，默认隐藏。
  5. 后端支持“模板自动生成命令”，用户可不写命令。
  6. 标题可不填，系统会从任务描述自动提取。
  7. 任务日志新增模板、口语描述、期望交付记录，便于审计。

- 实测：通过网页创建“小说多Agent模板”任务（仅口语描述，无手填命令）成功入库，自动生成执行命令。

## Agent Team 控制台 V2（阶段2+3：交付页与看板友好化）

- 用户继续要求优化“交付界面 + 看板可读性”。
- 已完成并上线：
  1. 任务详情页新增「交付总览（更友好）」：
     - 完成/失败/运行中的一句话状态结论
     - 进度条
     - 下一步建议
     - 最新日志摘要
     - 交付包/报告/审计/其他文件计数
     - 一键下载交付包按钮（自动识别优先压缩包）
  2. 首页新增「业务看板（更友好）」：
     - 按阶段分列：待理解 / 执行中 / 待你确认 / 需返工
     - 每列显示任务卡与快捷操作（启动/停止/重置）
  3. 原“技术任务列表”保留为折叠区「技术明细表（高级）」，兼顾高级用户排障。

- 验证：
  - 首页可见业务看板分列与阶段计数。
  - 任务详情页可见交付总览与一键下载按钮。

## Agent Team 控制台 V2（阶段4：全局角色中心 + 工作流中心）

- 用户同意继续后，已完成平台级重构：
  1. 新增 `roles` 表：角色 code/名称/职责/默认模型/启停状态。
  2. 新增 `workflows` 表：模板 code/名称/阶段列表/默认角色/默认任务类型/命令模板。
  3. 首页新增两个管理区：
     - 全局角色中心（可新增、启停）
     - 工作流模板中心（可新增、启停）
  4. 新建任务页的模板下拉改为读取“工作流中心”启用项。
  5. 高级设置里的执行角色改为读取“角色中心”启用项。
  6. 任务创建时自动继承工作流默认 `task_type/assignee`；命令优先读取工作流命令模板（支持 `__PROJECT_DIR__` 占位符）。
- 默认预置：
  - 角色：Lead/@developer/@tester/@verifier/@release/@research
  - 工作流：custom_brief/dev_test_verify/research_report/novel_multiagent/xhs_virtual_keywords
- 联调验证：
  - 成功新增角色 `@pm`（产品经理 Agent）。
  - 成功新增工作流 `pm_dev_test`，并出现在任务模板下拉中。

## Agent Team 控制台 V2（阶段5：整站视觉与排版重构）

- 用户反馈“页面太潦草”，要求整站布局优化。
- 已完成模板级重排并上线：
  1. `dashboard.html`
     - 全局视觉统一：软边框卡片、圆角、阴影、信息层级更清晰。
     - 顶部状态胶囊（并发/活跃/排队）+ 操作按钮。
     - KPI 区、口语任务区、业务看板、高级技术表、角色中心、工作流中心全部重新布局。
     - 业务看板改为卡片化阶段列，任务卡更易读。
  2. `task_detail.html`
     - 头部信息卡 + 状态徽章 + 快捷操作。
     - 左侧“交付总览/目录变量/输入附件”，右侧“输出产物+日志”，信息聚焦更明确。
     - 日志区样式重做，长时间阅读更友好。
  3. `artifacts.html`
     - 重做为“全局产物中心”风格，与主面板统一。
  4. `login.html`
     - 登录页重做（渐变背景 + 品牌卡片），视觉更现代。
- 验证：
  - 首页、任务详情、登录页、产物页均可正常渲染。
  - 服务重启后状态 `active`。

## 角色模型统一（同日）

- 用户要求：所有角色模型统一为 `gpt-5.3-codex`，且先验证再落地。
- 已做验证：
  - `session_status(model='gpt-5.3-codex')` 返回正常，模型解析为 `sydney-proxy/gpt-5.3-codex`。
  - 本地配置检索到 `gpt-5.3-codex` 已存在于 OpenClaw 配置。
- 已落地：
  - 线上控制台数据库 `roles.default_model` 全量更新为 `gpt-5.3-codex`（含 Lead/@developer/@tester/@verifier/@release/@research/@pm）。
  - 代码中默认角色模型（`init_db` 的 `default_roles`）已统一为 `gpt-5.3-codex`，防止后续新增实例回退到旧模型。
- 验证：
  - 页面角色中心已仅显示 `gpt-5.3-codex`（7 个角色）。

## 看板可用性修正（同日）

- 用户反馈两点：
  1) 任务类型太多，阅读负担大；
  2) 删除入口在新布局中不明显（看起来像“没了”）。
- 已修正：
  - 将任务类型下拉精简为 4 类：`general/backend/research/ops`（含中文注释）。
  - 工作流默认任务类型下拉同样精简为 4 类。
  - 在业务看板任务卡恢复并显式提供“删除”按钮（含二次确认）。
  - 在任务详情页顶部操作区也加入“删除”按钮。
- 验证：
  - 首页可见精简后的类型选项。
  - 首页看板卡片与任务详情页均可见删除按钮。

## 看板继续精简（同日）

- 用户反馈：业务阶段看板“类型过多且不好看”。
- 已进一步优化：
  - 业务看板阶段从 4 个精简为 3 个：`待处理 / 执行中 / 待确认`。
  - 失败任务并入“待处理”，以 `返工` 红色标记突出。
  - 看板任务卡操作按状态简化：
    - running：仅显示“停止”
    - done：显示“重置 + 删除”
    - pending/failed：显示“启动 + 删除”
  - 列宽重排为 3 列布局（`col-xl-4`），卡片阅读密度更舒适。
- 验证：页面已显示“已精简为 3 个阶段”。

## 看板卡片信息样式优化（同日）

- 用户指出示例展示“#13 + 标题 + 角色 + 时间”挤在一起，不好看。
- 已调整业务看板任务卡：
  - 标题单独一行（最多2行截断，防止撑破）。
  - 元信息改为胶囊标签：`#ID`、`执行角色`、`优先级`。
  - 时间改为单独行：`更新时间：...`。
  - 失败任务仍保留 `返工` 红色标签。
- 验证：首页已可看到 `meta-chip` 样式（例如 #13 的卡片）。

## 看板时间与标题样式修正（同日）

- 用户反馈：
  1) 更新时间要改为北京时间；
  2) 标题不想要蓝色下划线；
  3) 序号放到标题里。
- 已修正并上线：
  - 新增时间转换：页面展示统一为 `北京时间`（UTC+8）。
  - 任务标题链接改为深色无下划线（hover 仍保持整洁样式）。
  - 看板任务卡标题改为 `#ID + 标题`，移除独立 ID 标签。
  - 技术明细表同样改为标题内含 `#ID`，并去掉单独 ID 列。
- 验证：首页可见例如：`#13 ...`，时间显示为 `北京时间`。

## 真多Agent独立会话（同日）

- 用户明确要求“真多Agent独立会话完成任务”，并说明模型不固定，后续会按角色提供不同模型API。
- 已完成后端重构（非标签角色）：
  1. 数据层新增/扩展：
     - `tasks.workflow_code`
     - `roles.api_base/api_key/system_prompt/temperature/max_tokens`
     - `workflows.stage_roles_json`
     - 新表 `role_session_messages`（按 task_id + role_code 持久化独立会话历史）
  2. 执行层新增：
     - 当任务 `command` 为空且有 `workflow_code` 时，走 `run_multi_agent_workflow`。
     - 各阶段按 `stage_roles_json` 分派角色，调用各角色独立 API + 模型。
     - 每阶段写入独立产物文件 `阶段N_阶段名_角色.md`。
     - 生成 `多Agent_最终交付.md` + `多Agent_会话审计.json`。
  3. 角色中心升级：
     - 每个角色可单独配置模型/API Base/API Key/temperature/max_tokens/system prompt。
     - 页面显示 API 就绪状态（已配置/未配置）。
  4. 工作流中心升级：
     - 支持阶段→角色映射（`stage_roles`）。
- 联调验证：
  - 创建任务 `#14`（custom_brief，命令留空）成功触发多Agent流程。
  - 因角色尚未配置 API，任务按预期失败并给出明确日志：`角色 Lead Agent 未配置 api_base`。
  - 说明“真多Agent链路”已接通，当前阻塞仅是角色 API 配置待用户提供。

## 全角色 gpt-5.3-codex 跑通验证（同日）

- 用户要求：先将角色统一用 `gpt-5.3-codex` 跑通测试。
- 已执行：
  1. 从主节点可用模型配置读取 `sydney-proxy` 网关地址与 key；
  2. 将控制台全部角色统一更新为：
     - `default_model = gpt-5.3-codex`
     - `api_base = https://xiaoji.caopi.de`
     - `api_key =（已写入，未展示明文）`
- 跑通结果：
  - 任务 `#14`（custom_brief）最终 `done, rc=0`，覆盖 `Lead Agent + @developer + @verifier`。
  - 任务 `#15`（dev_test_verify）最终 `done, rc=0`，覆盖 `@developer + @tester + @verifier + @release`。
  - `#15` 审计文件显示四阶段模型均为 `gpt-5.3-codex`，并生成：
    - `阶段1_开发_at_developer.md`
    - `阶段2_测试_at_tester.md`
    - `阶段3_验证_at_verifier.md`
    - `阶段4_交付_at_release.md`
    - `多Agent_最终交付.md`
    - `多Agent_会话审计.json`

## 角色词（system prompt）补齐（同日）

- 用户追问“每个角色词是否已加”。
- 结论：此前主要依赖角色职责描述自动拼接，未显式为每个角色配置完整 system prompt。
- 已修复：
  - 在 `init_db` 中增加 `role_prompts` 默认映射，并对 `system_prompt` 为空的角色自动回填。
  - 已验证线上数据库 7 个角色均有非空 `system_prompt`（含 Lead/@developer/@tester/@verifier/@release/@research/@pm）。
- 作用：角色独立会话调用模型时，会优先使用对应角色词，不再仅靠通用回退文案。

## 模型切换：复核保留 gpt-5.3-codex，其余切 MiniMax-M2.5（同日）

- 用户提供中国区 MiniMax API key，并要求先验证后切换。
- 可用性验证（切换前）：
  - `https://api.minimaxi.com/v1/chat/completions` + `model=MiniMax-M2.5` 请求成功（返回 completion）。
  - `https://api.minimax.io` 对该 key 返回 401（确认应走中国区域端点）。
- 角色配置更新：
  - `@verifier`：保持 `gpt-5.3-codex`（原 gpt 网关）。
  - 其他角色（Lead/@developer/@tester/@release/@research/@pm）：
    - `default_model = MiniMax-M2.5`
    - `api_base = https://api.minimaxi.com/v1`
    - `api_key = 用户提供的中国区 key`
- 跑通验证：
  - 新任务 `#16`（`dev_test_verify`，命令留空，真多Agent独立会话）最终 `done, rc=0`。
  - 审计文件模型映射：
    - 开发 `@developer` → `MiniMax-M2.5`
    - 测试 `@tester` → `MiniMax-M2.5`
    - 验证 `@verifier` → `gpt-5.3-codex`
    - 交付 `@release` → `MiniMax-M2.5`

## 多Agent闭环返工机制（同日）

- 用户要求：每个角色只做本角色工作；复核不通过自动打回重做；避免无限循环。
- 已实现：
  1. 工作流执行从“线性一次过”升级为“可回退闭环”。
  2. 复核阶段（`@verifier` 或阶段名含验证/复核）强制输出结构化结论（PASS/FAIL + 问题 + 打回角色 + 修改要求）。
  3. FAIL 自动打回到指定角色对应阶段（默认回退上一阶段），并携带返工说明继续流转。
  4. 增加防无限循环：
     - `ATC_MAX_REWORK_ROUNDS`（默认 2 轮）
     - 迭代上限保护（超限自动终止）
  5. 审计增强：记录每一步 `executionNo/reworkRound/reviewDecision`。
- 验证任务：`#17`
  - 首次复核 FAIL 并打回开发（日志可见 `复核未通过，打回到阶段1`）。
  - 二次复核 PASS，最终任务 `done, rc=0`。
  - 审计显示 `reworkRoundsUsed=1`，步骤总数 7（含返工重跑）。
    - `阶段1_开发_at_developer.md`
    - `阶段2_测试_at_tester.md`
    - `阶段3_验证_at_verifier.md`
    - `阶段4_交付_at_release.md`
    - `多Agent_最终交付.md`
    - `多Agent_会话审计.json`
