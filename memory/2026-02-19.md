# 2026-02-19 记忆存档

## Agent Team 浏览器控制台部署（agent.caopi.de）

- 用户提供域名：`agent.caopi.de`，已解析到萝卜（`152.53.171.21`）。
- 核查发现原先该域名命中 AList 且证书不匹配（`alist.duolaameng1999.de`），需独立站点配置。

### 已完成动作
1. 在仓库新增项目 `agent-team-console/`（Flask + Gunicorn + SQLite）并推送 GitHub：
   - 提交：`df2deff` (`feat: add browser-based agent team console MVP`)
2. 在萝卜部署运行：
   - 路径：`/opt/agent-team-console`
   - 服务：`agent-team-console.service`（systemd）
   - 监听：`127.0.0.1:3100`
3. Nginx 接入域名：
   - 新增 `agent.caopi.de` 反代配置
   - 申请并部署 Let's Encrypt 证书（SAN: `agent.caopi.de`）
4. 验证通过：
   - `https://agent.caopi.de` 可访问
   - 登录成功（账号：`root`，密码：`k5348988`）
   - 首页跳转 `/login`，登录后可进任务面板

### 当前能力（MVP）
- 浏览器登录
- 新建任务（类型/优先级/执行者）
- 启动/停止/重置任务
- 任务状态看板（pending/running/done/failed）
- 任务日志页自动刷新
- 并发上限默认 4（可调）

### 待下一步（可选）
- 增加 Telegram 回调通知（成功/失败）
- 增加角色并发限流（如 QA 单独 1）
- 增加项目级隔离与多项目视图
- 接入 OpenClaw 子会话执行（替代 shell 命令执行）

## 追加优化（同日）

- 用户反馈“页面无法改并发、中文提示不足”。
- 已上线修复：
  - 新增“系统设置”卡片，可在页面直接修改并发（1-16），并且**即时生效**（无需重启）。
  - 新增运行状态细分展示：活跃执行、排队中。
  - 全面增强页面汉化与操作提示（登录页、面板、任务详情页）。
  - 扩展任务类型选项（backend/frontend/qa/release/research/db/ops/debug/docs/general）。
- 验证：通过 `POST /settings/concurrency` 将并发改为 3 再恢复 4，`/healthz` 实时反映成功。
- 代码提交：`6e39fa7`。

## 追加优化（同日-2）

- 用户要求：下拉选项增加中文注释。
- 已完成：
  - 任务类型下拉改为“英文标识 + 中文释义”（如 `backend（后端接口开发）`）。
  - 执行角色下拉改为“角色名 + 中文职责说明”（如 `Lead Agent（总控/分派）`）。
  - 新建任务区域补充中文提示：类型用于分类统计，角色用于责任归属。
- 线上验证：`agent.caopi.de` 页面已出现中文注释文案。

## 追加优化（同日-3）

- 用户反馈“执行命令（可选）”对小白过于模糊。
- 已完成新手友好改造：
  - 新增“业务模板（新手推荐）”下拉（后端回归、前端构建、数据库迁移、服务巡检、日报任务）。
  - 新增“项目路径”输入 + “一键填充到命令框”按钮，自动生成可执行命令。
  - 将原命令输入区改名为“高级模式：自定义命令（懂命令时再填）”。
  - 明确提示：命令留空=演示流程，不执行业务。
- 线上验证：页面已出现“业务模板（新手推荐）”和 JS 填充逻辑。

## 追加优化（同日-4）

- 用户反馈：点击“一键填充”后页面闪一下，输入内容消失。
- 根因：面板默认每6秒整页自动刷新，恰好覆盖用户填表过程。
- 已修复：
  - 取消 `<meta refresh>` 强制刷新。
  - 改为 JS 空闲刷新策略：仅在“未编辑表单且未聚焦输入框”时自动刷新。
  - 增加“自动刷新：开/关”按钮，用户可手动切换。
  - 增加顶部提示文案，明确编辑时会自动暂停刷新，防止内容丢失。
  - 顺手增强模板填充兼容性（`replaceAll` 改为 `split/join`）。
- 线上验证：页面已出现“自动刷新：开”按钮与新提示文案。

## 追加优化（同日-6）

- 用户反馈：希望任务创建时可上传文件，且下载应按任务对应，避免全局下载页对小白不友好。
- 已完成：
  - 新建任务表单新增“上传附件（可选）”（支持多文件）。
  - 每个任务新增独立目录：`/opt/agent-team-console/artifacts/task_<id>/`
    - 输入附件：`input/`
    - 输出产物：`output/`
  - 任务详情页新增：
    - 附件上传区（可追加上传）
    - 输入附件下载列表
    - 输出产物下载列表
  - 新增任务专属下载接口：`/tasks/<id>/download/<path>`（含路径安全校验）。
  - 任务执行注入环境变量：`TASK_INPUT_DIR`、`TASK_OUTPUT_DIR`、`TASK_ARTIFACT_DIR`、`TASK_ID`。
  - 新建任务页改为 `multipart/form-data`，并提示按任务下载。
- 验证：创建带附件任务后，可在任务详情页直接下载该任务 `input` 文件。

## 追加优化（同日-7）

- 用户需求：任务列表需要“删除”操作，不仅有启动/停止/重置。
- 已完成：
  - 任务列表新增“删除”按钮（带确认弹窗）。
  - 删除逻辑：删除任务记录 + 日志 + 该任务目录下 input/output 附件产物。
  - 保护：若任务正在运行/排队，禁止删除，需先停止。
- 验证：创建测试任务后执行删除，`api/tasks` 中该任务已移除。

## 追加优化（同日-9）

- 用户反馈：小红书模板任务执行失败，`rc=1`。
- 日志定位：`cd /root/.openclaw/workspace: No such file or directory`（萝卜部署环境下该路径不存在）。
- 已修复：
  - 模板“项目路径”默认值改为运行时工作目录（线上为 `/opt/agent-team-console`）。
  - JS 填充命令的兜底路径同步改为运行时工作目录，避免再次写入错误路径。
- 已做现场补救：任务 #3 的命令路径已修正并重置为 pending，可直接重新启动。

## 追加优化（同日-8）

- 用户需求：新增任务模板「小红书店铺商品高频词（偏虚拟产品类目）」。
- 已完成：
  - 在“业务模板（新手推荐）”新增模板：`小红书虚拟产品高频词（自动分析）`。
  - 新增脚本：`agent-team-console/scripts/xhs_virtual_keywords.py`。
  - 模板命令会输出到任务专属产物目录：
    - `$TASK_OUTPUT_DIR/xhs_virtual_keywords.md`
    - `$TASK_OUTPUT_DIR/xhs_virtual_keywords.json`
- 运行验证：在萝卜上单关键词测试已成功产出 `/tmp/xhs_kw.md` 和 `/tmp/xhs_kw.json`。

## 追加优化（同日-10）

- 用户反馈：模板执行后词频结果被“安全限制/网络风险”等风控文案污染，数据不可信。
- 根因：小红书网页端触发风控验证页，脚本把拦截页文本当成有效内容统计。
- 已修复：
  - 脚本新增风控词识别（`RISK_TERMS`），命中后将该采样源标记为 `blocked`，不纳入词频。
  - 报告新增有效性指标：`usableSourceCount`、`blockedSourceCount`。
  - 新增 `--strict` 与 `--min-usable`：有效采样不足时返回非0，避免“看似成功但结果无效”。
  - 模板命令已升级为 strict 模式（`--strict --min-usable 2`）。
  - 将当前小红书任务重置为 pending 并注入新命令，可直接重跑。
- 验证：在萝卜上 strict 模式测试，风控场景下脚本返回 `code=2` 并明确提示“结果不可信”。

## 追加优化（同日-5）

- 用户需求：任务产物希望在浏览器直接下载，不再手动SSH到服务器取文件。
- 已完成：
  - 新增“产物下载”页面：`/artifacts`。
  - 新增下载接口：`/artifacts/download/<rel_path>`（登录后可用，含路径安全校验）。
  - 顶部导航新增“产物下载”入口。
  - 任务创建页新增说明：将产物放入 `/opt/agent-team-console/artifacts` 后可直接下载。
  - 服务器已创建产物目录：`/opt/agent-team-console/artifacts`。
- 验证：创建 `demo.txt` 后，页面可见且浏览器下载成功。
